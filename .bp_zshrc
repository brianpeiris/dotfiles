# Disable flow control
stty -ixon

setopt menu_complete

# Vim mode
bindkey -v
bindkey -M vicmd '?' history-incremental-search-backward
bindkey -M viins '^P' history-incremental-search-backward
bindkey -M viins '^N' history-incremental-search-backward

winuser="$(cmd.exe /c 'echo %username%' 2>/dev/null | tr -d '\r')"
winhome="/mnt/c/Users/$winuser"

if [ ! -e $winhome ]; then
    winhome=$HOME
fi

adhoc="$winhome/.adhoc_zshrc"
alias ea='vim $adhoc'
alias ec='vim ~/dotfiles/.bp_zshrc'
alias rc='source ~/dotfiles/.bp_zshrc'

alias ~~='cd "$winhome"'

function start_ssh_agent {
    if [ -z "$SSH_AGENT_PID" ]; then
        eval `ssh-agent -s` > /dev/null
        ssh-add
    fi
}
alias sa=start_ssh_agent
start_ssh_agent

function run_smooth() {
    oldoutput=""
    while (true) {
        run="unbuffer $* 2>&1"
        output=$(eval $run)
        if [[ "$output" != "$oldoutput" ]]
        then
            clear
            tput cup 2 0
            echo -E "$output"
            oldoutput="$output"
        fi
        tput cup 0 0
        echo $(date)
        sleep 1
    }
}
alias rs=run_smooth

function android_ip() {
    adb shell ifconfig | grep "inet addr" | grep -v 127 | cut -d":" -f2 | cut -d" " -f1
}
alias aip=android_ip
function adb_remote() {
    ip=$(android_ip)
    adb tcpip 5555
    adb connect $ip
}
alias adbr=adb_remote
alias adbi='adb install -r'
alias adbd='adb disconnect'
alias adbl='adb devices'
alias awak='adb shell input keyevent 26'
alias atemp='adb shell "while true; do cat /sys/devices/virtual/thermal/thermal_zone0/temp; sleep 1; done"'
alias abat='adb shell "while true; do dumpsys battery | grep level | cut -d\" \" -f4; sleep 1; done"'
function acpu {
	while true; do
		adb shell 'top -m 1 -n 1 | grep User | grep User | head -1 | cut -d" " -f2 | cut -d% -f1';
	done
}

function plot {
	feedgnuplot --stream --terminal "dumb 160,40" --xlen 160 --unset grid --title $1 --ymin $2 --ymax $3
}

alias ginit='git init && git add . && git commit -m "initial commit"'
alias gname='git rev-parse --abbrev-ref HEAD'
alias push='git push'
alias pull='git pull'
alias gpm='git pull origin master'
alias gpm='git pull origin master'
alias gbv='git branch -vv'
alias code='cd "$winhome/Code"'
function gcm {
    git commit -m "$*"
}
function gcam {
    git commit -am "$*"
}
function pushr {
    remote=$1
    git push $remote $(gname)
}
alias pusho='pushr origin'

alias notes='tmux rename-window notes; vim "$winhome/Documents/notes.txt"'
alias ip='ifconfig | grep -i wifi -C1 | tail -1 | cut -d":" -f2 | sed "s/ .\\+//"'

alias rg='rg -S --path-separator "/"'
alias rgc='rg --type cs'

function github_clone {
    repo=$1
    git clone git@github.com:$repo $repo
    cd $repo
}
alias ghcl=github_clone

function _find_refs() {
    echo "Finding matches for script $1 ..."
    local guid="$(grep guid "$line" | sed 's/^.* //')"
    grep -R "$guid" Assets | grep -v "$1"
    echo ""
}
function find_refs() {
    find Assets -iname "*$1*.meta" | while read line; do
        _find_refs "$line"
    done
}

function mcd() {
    mkdir -p $1
    cd $1
}

function vid() {
    echo "$(vagrant.exe ssh-config | grep -i identityfile | cut -d'"' -f2 | sed 's/C:/\/mnt\/c/')"
}

alias v=vagrant.exe
alias ys='yarn start --no-open'

alias ys='yarn start --no-open'

function vsh() {
    identity=$(vid)
    ssh -p 2222 -i $identity ubuntu@localhost
}

function vcp() {
    identity=$(vid)
    scp -i $identity -P 2222 -- $1 $2
}

PATH=$(echo $PATH | tr ':' '\n' | grep -vi ruby | tr '\n' ':')

[ -e $adhoc ] && source $adhoc

unalias gcm > /dev/null 2>&1
unalias gcam > /dev/null 2>&1

export PATH="$HOME/.local/bin:$PATH"
export LS_COLORS='di=34:ln=35:so=32:pi=33:ex=31:bd=34;46:cd=34;43:su=30;41:sg=30;46:tw=34:ow=34'
